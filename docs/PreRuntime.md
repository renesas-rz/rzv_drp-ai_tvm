
# DRP-AI Pre-processing Runtime
This page explains about the DRP-AI Pre-processing Runtime, which includes its supported operations and APIs.

## Index
- [1. Overview](#1-overview)  
    - [1.1 Function](#11-function)  
    - [1.2 Terminology](#12-terminology)  
    - [1.3 Requirement](#13-requirement)
    - [1.4 About Memory Management](#14-about-memory-management)
- [2. Compile Module ](#2-compile-module)  
    - [2.1 Overview](#21-overview)  
    - [2.2 File Configuration](#22-file-configuration)  
    - [2.3 Supported Operations](#23-supported-operations)
        - [2.3.1 Input/Output](#231-inputoutput)
        - [2.3.2 Operators](#232-operators)
    - [2.4 API](#24-api)
        - [2.4.1 Runtime Class](#241-runtime-class)
        - [2.4.2 Operator Class](#242-operator-class)
        - [2.4.3 Constant Variables](#243-constant-variables)
    - [2.5 Integration](#25-integration)
    - [2.6 Sample Code](#26-sample-code)
        - [2.6.1 Pre-processing](#261-pre-processing)
        - [2.6.2 Post-processing](#262-post-processing)
- [3. Run Module ](#3-run-module)  
    - [3.1 Overview](#31-overview)  
    - [3.2 File Configuration](#32-file-configuration)  
    - [3.3 API](#33-api)
        - [3.3.1 Load](#331-load)
        - [3.3.2 Pre](#332-pre)
    - [3.4 Structure](#34-structure)
        - [3.4.1 s_preproc_param_t](#341-s_preproc_param_t)
    - [3.5 Macro](#35-macro)
        - [3.5.1 Format](#351-format)
        - [3.5.2 Resize Algorithm](#352-resize-algorithm)
        - [3.5.3 Argminmax Mode](#353-argminmax-mode)
        - [3.5.4 Pre/Post Mode](#354-prepost-mode)
    - [3.6 Format Parameter Change Restriction](#36-format-parameter-change-restriction)
    - [3.7 Integration](#37-integration)
        - [3.7.1 Include Command](#371-include-command)
        - [3.7.2 Input Data](#372-input-data)
    - [3.8 Sample Code](#38-sample-code)
        - [3.8.1 Pre-processing](#381-pre-processing)
        - [3.8.2 Post-processing](#382-post-processing)

## 1. Overview  
### 1.1 Function  
DRP-AI Pre-processing Runtime enables high performance AI pre-processing and optionally post-processing using the hardware accelerator, DRP-AI.  
It is provided in DRP-AI TVM[^1] as its one of features.  
Users can use the DRP-AI Pre-processing Runtime by compiling the processing with **"DRP-AI Pre-processing Compile module"** (python APIs) and run it on the board by calling **"DRP-AI Pre-processing Run Module"** (C++ APIs).  

<img src=./img/overview.png width=400>  

As an option, some of post-processing can also be accelerated using the DRP-AI Pre-processing Runtime.  
This is implemented in POST mode.  

### 1.2 Terminology  
| Terms | Explanation |
|:------------------------------|:-------------|
| DRP-AI | Name of the Renesas architecture that accelerates the inference of neural networks.|  
| AIMAC | Components of the DRP-AI. Mainly used for the operation of the convolutional layer.|  
| DRP | Components of the DRP-AI. Mainly used for the operation of layers other than the above and pre and postprocessing.|  
| DRP-AI Pre-processing Runtime Object files | Files required to run DRP-AI generated by DRP-AI Pre-processing Runtime Compile module.  </br>- AIMAC descriptor and command files (`aimac_desc.bin`, `aimac_cmd.bin`<sup>*1</sup>, `aimac_param_cmd.bin`<sup>*1</sup> and `aimac_param_desc.bin`<sup>*1</sup>)  </br>- DRP descriptor (`drp_desc.bin`)  </br>- DRP parameter (`drp_param.bin`)  </br>- DRP parameter Information (`drp_param_info.txt`)  </br>- Weight data (`pp_weight.dat` or `weight.bin`)  </br>- DRP configuration data (`pp_drpcfg.mem` or `drp_config.mem`)|
| DRP-AI memory area | Dedicated area on Memory Map of RZ/V series (RZ/V2L, RZ/V2M, RZ/V2MA, RZ/V2H, RZ/V2N) Linux used by DRP-AI. |  

<sup>*1</sup>: Only for RZ/V2H and RZ/V2N. 

### 1.3 Requirement  
To use DRP-AI Pre-processing Runtime, please prepare the DRP-AI TVM[^1] environment explained in [Installation](../README.md#installation).  

### 1.4 About Memory Management
DRP-AI computes the processing using data mapped to a physically contiguous memory area.  
In RZ/V Linux Package, **"DRP-AI memory area"** is reserved for DRP-AI.  
DRP-AI Pre-processing Runtime Object files must be deployed to the DRP-AI memory area before running the DRP-AI.  

Since DRP-AI TVM[^1] also uses DRP-AI memory area, DRP-AI TVM[^1] and DRP-AI Pre-processing Runtime must use **mutually exclusive area**.  
Overlapping the memory area used by DRP-AI TVM[^1] and DRP-AI Pre-processing Runtime will cause the DRP-AI error.  

<!--
In DRP-AI TVM[^1], the memory address must be defined when compiling the model.  
In [Compile Tutorial](../tutorials/README.md), `addr_map_start` is the memory address that DRP-AI TVM[^1] Model Object is deployed.  
For example, following shows that DRP-AI TVM Model Object will be deployed to memory area after the address of `0x438E0000`. 
```
drp_config_runtime = {
    "interpreter": False,
    "addr_map_start": 0x438E0000,
    "toolchain_dir": <TRANSRATOR PATH>,
    "sdk_root": <SDK PATH>
}
```
-->

By default, DRP-AI TVM[^1] and DRP-AI Pre-processing Runtime use the DRP-AI memory area as follows.  
- In `PreRuntime.cpp`  
    - Use [DRP-AI memory area start addres] + `0x0` for pre-processing runtime.
    - Users are required to specify the start address of memory area used by DRP-AI TVM[^1].<br> ([`tutorial_app_v2ml.cpp`](../apps/tutorial_app_v2ml.cpp) uses  [DRP-AI memory area start addres] + `0x38E0000`).
- In `PreRuntimeV2H.cpp`:  
    - Use the end of DRP-AI memory area for pre-processing runtime.
    - Use [DRP-AI memory area start addres] + `0x0` for DRP-AI TVM[^1].  

<img src=./img/defaultmemorymanagement.jpg width=600>  

In DRP-AI TVM[^1], the start address of the memory area to be used can be specified when running the AI model on the target board.  
Please see `LoadModel()` in [tutorial_app*.cpp](../apps) for more details.

In DRP-AI Pre-processing Runtime, the start address of memory area that Object files area deployed can be defined when running the pre-processing on the target board.  
To see how to define the start address, please refer to [Run module API Load()](#331-load).  


Memory area that DRP-AI uses consists of following spaces list.  
Their address details and the size required are included in the address map txt file (`*addrmap_intm.txt`) in DRP-AI Pre-processing Runtime Object files.  

| Name | Details |
|:---|:---|
| data_in | Memory area to place the input data to DRP-AI.|  
| data | Work area for AIMAC. |
| data_out | Memory area to place the final inference results.</br>DRP-AI Pre-processing Runtime reads data from this area to obtain the DRP-AI output.| 
| work | Work area for DRP. |
| weight | Memory area to place the weight data of the neural network.</br>DRP-AI Pre-processing Runtime writes the weight data to this area. |
| drp_config | Memory area to place DRP configuration data.</br>DRP-AI Pre-processing Runtime writes the DRP configuration data to this area. |
| drp_param | Memory area to place DRP parameter.</br>DRP-AI Pre-processing Runtime writes the DRP parameter to this area. |
| aimac_cmd | Memory area to place AIMAC command.</br>DRP-AI Pre-processing Runtime writes the AIMAC command to this area.</br>Used in RZ/V2H and RZ/V2N. |
| desc_aimac or aimac_desc | Memory area to place AIMAC descriptor.</br>DRP-AI Pre-processing Runtime writes the AIMAC descriptor to this area. |
| aimac_param_cmd | Memory area to place AIMAC parameter command.</br>DRP-AI Pre-processing Runtime writes the AIMAC parameter command to this area. </br>Used in RZ/V2H and RZ/V2N.|
| aimac_param_desc | Memory area to place AIMAC parameter descriptor.</br>DRP-AI Pre-processing Runtime writes the AIMAC parameter descriptor to this area.</br>Used in RZ/V2H and RZ/V2N. |
| desc_drp or drp_desc|  Memory area to place DRP descriptor.</br>DRP-AI Pre-processing Runtime writes the DRP descriptor to this area. |


## 2. Compile Module
### 2.1 Overview
DRP-AI Pre-processing Runtime Compile module is a function of DRP-AI TVM[^1].  
It allows users to compile the specified processing into executable format (DRP-AI Pre-processing Runtime Object files) on DRP-AI.  

### 2.2 File Configuration
Following files are required to run DRP-AI Pre-processing Runtime Compile module.  

| File |   
|:---|  
| `drpai_preprocess/__init__.py` |  
| `drpai_preprocess/drpai_param.py` |  
| `drpai_preprocess/op.py` |  
| `drpai_preprocess/preruntime.py` |  

### 2.3 Supported Operations
#### 2.3.1 Input/Output
| Parameters | Input |  Output  |  
|:------------------------------|:-------------|:---|  
| Format | YUV422</br>YUV420</br>RGB</br>BGR</br>Grayscale</br>|RGB</br>BGR</br>Grayscale</br>|
| Order | HWC|HWC</br>CHW|  
| Type | uint8</br>fp16</br>fp32</br> |uint8</br>fp16</br>fp32</br> |  

Notes
1. See [Format](#2431-format) for YUV details.  
2. Following cases are not supported.
    - Input Format = YUV420 & Output Format = Grayscale
    - Input Format = Grayscale & Output Format = Other than grayscale
    - Input Type = Other than uint8 & Output Type = uint8

#### 2.3.1.1 POST mode
In POST mode, supported input/output changes accordingly.  

| Parameters | Input |  Output  |  
|:------------------------------|:-------------|:---|  
| Format | N/A|N/A|
| Order | HWC</br>C|HWC</br>CHW</br>C|  
| Type | fp16</br>fp32</br> |uint8</br>fp16</br>fp32</br> |  


#### 2.3.2 Operators
Supported pre-processing operators are as follows.  

| Operators | Explanation |  
|:------------------------------|:-------------|  
| Crop | Crop the image data into specified size.|  
| Resize | Resize the image data into specified size.|  
| Normalize | Normalize pixel values with specified coefficients. |  

Note:
1. Color conversion, transpose and cast are automatically done according to the format/order/type that user specified.
2. Pre-processing will be run in the order shown in the table above.
3. ON/OFF of each process can be specified.

#### 2.3.2.1 POST mode
In POST mode, supported processing operators are as follows.  

| Operators | Explanation |  
|:------------------------------|:-------------|  
| Argminmax | Argmin/Argmax the specified axis.|  
| Softmax | Softmax the 1-dimensional data.|  

Note:
1. Color conversion is not available.
2. Transpose and cast are automatically done according to the order/type that user specified.
3. Operators are mutually exclusive and only one operator can be specified.

### 2.4 API  
API list is as follows.  

| Module| Class | Category | Description |  
|:---|:---|:---|:---|  
| preruntime |[PreRuntime()](#2411-preruntime) | Runtime Class | Class to run DRP-AI Pre-processing Runtime. |  
| preruntime |[Config()](#2412-config) | Runtime Class | Class to define the pre-processing details. |  
| op |[Crop()](#2421-crop) | Operator Class | Class for Crop operation. |  
| op |[Resize()](#2422-resize) | Operator Class | Class for Resize operation. |  
| op |[Normalize()](#2423-normalize) | Operator Class | Class for Normalize operation. |  
| op |[Argminmax()](#2424-argminmax) | Operator Class | Class for Argminmax operation in POST mode.|  
| op |[Softmax()](#2425-softmax) | Operator Class | Class for Softmax operation in POST mode. |  
| drp_param |[Format](#2431-format) | Constant Variable | Constant variables for in/out format. |  
| drp_param |[Order](#2432-order) | Constant Variable | Constant variables for in/out order. |  
| drp_param |[Type](#2433-type) | Constant Variable | Constant variables for in/out type. |  
| drp_param |[Mode](#2434-mode) | Constant Variable | Constant variables for PRE/POST mode. |  

#### 2.4.1 Runtime Class
Runtime class is used to control the DRP-AI Pre-processing Runtime.

##### 2.4.1.1 PreRuntime()
```py
preruntime.PreRuntime(config, out_dir, product)
```
- Explanation  
    - Class to run DRP-AI Pre-processing Runtime.  
    - By defining this class, the DRP-AI Pre-processing Runtime Compile module will be run.
- Arguments  
    - `config` (*[preruntime.Config](#2412-config)*) : Pre-processing configuration.  See [Config](#2412-config) for more details.   
    - `out_dir` (*string*) : Name of the output directory to be generated.  
    - `product` (*string*) : RZ/V Product name. Default is `"V2L"`.  

##### 2.4.1.2 Config()
```py
preruntime.Config()
```
- Explanation  
    - Class to define the pre-processing details, such as input size, which operator to be used, etc.  
    - Define the pre-processing details after defined this class as shown in Class variables below.  

- Arguments  
    - None  

- Class variables  
Following variables must be defined before running the DRP-AI Pre-processing Runtime Compile module.  

| Variables | Type | Details |  
|:---|:---|:---|  
| `shape_in` | *[int, int, int, int]*| Input image data shape.</br>List must have size of 4 as NHWC.|  
| `format_in` | *`drpai_param.FORMAT`*| Input format.</br> See [Format](#2431-format) for *`drpai_param.FORMAT`*.|   
| `order_in` | *`drpai_param.ORDER`* | Input order.</br> See [Order](#2432-order) for *`drpai_param.ORDER`*.|   
| `type_in` |*`drpai_param.TYPE`*| Input Type.</br> See [Type](#2433-type) for *`drpai_param.TYPE`*.|   
| `shape_out` | *[int, int, int, int]*| Output data shape.</br>List must have size of 4 as NHWC/NCHW.|  
| `format_out` | *`drpai_param.FORMAT`*| Output format.</br> See [Format](#2431-format) for *`drpai_param.FORMAT`*.|   
| `order_out` | *`drpai_param.ORDER`* | Output order.</br> See [Order](#2432-order) for *`drpai_param.ORDER`*.|   
| `type_out` |*`drpai_param.TYPE`*| Output Type.</br> See [Type](#2433-type) for *`drpai_param.TYPE`*.|   
| `ops` | *list of [Operator Class](#242-operator-class)* | Operators to be run as pre-processing.</br> If no operator specified, only format/order/type conversion will be done as pre-processing.|   
| `mode` |*`drpai_param.MODE`*| **[Optional]** Running Mode.</br> Default value is `drpai_param.MODE.PRE`</br> See [Mode](#2434-mode) for *`drpai_param.MODE`*.|   


#### 2.4.2 Operator Class
Followings are operator class for operator explained in [Operator Class](#242-operator-class).  
##### Pre-processing operators
- [Crop](#2421-crop)  
- [Resize](#2422-resize)  
- [Normalize](#2423-normalize)  
  
##### Post-processing operators
- [Argminmax](#2424-argminmax)  
- [Softmax](#2425-softmax)  

##### 2.4.2.1 Crop()
```py
op.Crop(crop_tl_x, crop_tl_y, width, height)
```

- Arguments  
    - `crop_tl_x` (*int*) : X coordinates of top left corner of the crop box.   
    - `crop_tl_y` (*int*) : Y coordinates of top left corner of the crop box.  
    - `width` (*int*) : Width of the crop box.  
    - `height` (*int*) : Height of the crop box.  

- Restrictions  
    - `crop_tl_x` <= (width of input shape - 1)  
    - `crop_tl_y` <= (height of input shape - 1)  

- Supported In/Out parameters  

| Features | Input | Output |  
|:---|:---|:---|  
| Format | `drpai_param.FORMAT.RGB`</br>`drpai_param.FORMAT.BGR`</br>`drpai_param.FORMAT.GRAY`| Same as Input.|  
| Order | `drpai_param.ORDER.HWC`| Same as Input.|   
| Type | `drpai_param.TYPE.UINT8`</br> `drpai_param.TYPE.FP16` | Same as Input.|   


##### 2.4.2.2 Resize()
```py
op.Resize(width, height, algorithm)
```

- Arguments  
    - `width` (*int*) : Output Width of the crop box.  
    - `height` (*int*) : Output Height of the crop box.  
    - `algorithm` (*int*) : Resize algorithm to be used.  
        - `op.Resize.NEAREST` (Default) : Nearest neighbor algorithm.  
        - `op.Resize.BILINEAR` : Bilinear interpolation.  

- Restrictions  
    - 2 < (width of input shape) <= 4096  
    - 2 < (height of input shape) <= 4096  
    - (channel of input shape) <= 512  
    - 2 < `width` <= 4096  
    - 2 < `height` <= 4096  

- Supported In/Out parameters  

| Features | Input | Output |  
|:---|:---|:---|  
| Format | `drpai_param.FORMAT.RGB`</br>`drpai_param.FORMAT.BGR`</br>`drpai_param.FORMAT.GRAY`| Same as Input.|  
| Order | `drpai_param.ORDER.HWC`| Same as Input.|   
| Type | `drpai_param.TYPE.UINT8`</br> `drpai_param.TYPE.FP16` | Same as Input.|   

##### 2.4.2.3 Normalize()
```py
Normalize(cof_add, cof_mul)
```


- Arguments  
    - `cof_add` (*list of float*) : Addition coefficient in normalization.  
    - `cof_mul` (*list of float*) : Multiplication coefficient in normalization.  
    - Note: Above coefficients will be used in the following equation.  
        ```
        Dout = (Din + cof_add) * cof_mul  
        ```
    - Example  
        The following normalization may be used for the neural network input data.  
        ```
        range = 255
        img = img / range
        img = (img - mean) / stdev
        ```
        In the above case, find `cof_add` and `cof_mul` from `mean` and `stdev` using following conversion formulae.  
        ```
        cof_add = - (mean * range)
        cof_mul = 1/(stdev * range)
        ```

- Restrictions  
    - ( width of input shape ) * ( channel of input shape ) < 0xFFFFFFFF  

- Supported In/Out parameters  

| Features | Input | Output |  
|:---|:---|:---|  
| Format | `drpai_param.FORMAT.RGB`</br>`drpai_param.FORMAT.BGR`</br>`drpai_param.FORMAT.GRAY`| Same as Input.|  
| Order | `drpai_param.ORDER.HWC`| Same as Input.|   
| Type | `drpai_param.TYPE.UINT8`</br> `drpai_param.TYPE.FP16` </br> `drpai_param.TYPE.FP32` | `drpai_param.TYPE.FP16`|   
##### 2.4.2.4 Argminmax()
```py
op.Argminmax(axis, arg_mode)
```

- **Supported only when `Config.mode` = `drpai_param.MODE.POST`**  

- Arguments  
    - `axis` (*int*) : Target axis of argminmax operation.  
        - `0` : Channel  
        - `1` : Width  
        - `2` : Height  
    - `arg_mode` (*int*) : Arguments mode.  
        - `0` : Argmax  
        - `1` : Argmin  

- Restrictions  
    - (size of argminmax target axis) <=256
        - `axis`== 0 && (( channel of input shape ) <=256)  
        - `axis`== 1 && (( width of input shape ) <=256)  
        - `axis`== 2 && (( height of input shape ) <=256)  

- Supported In/Out parameters  

| Features | Input | Output |  
|:---|:---|:---|  
| Format | N/A | N/A|  
| Order | `drpai_param.ORDER.HWC`</br>`drpai_param.ORDER.CHW`| Same as Input.|   
| Type | `drpai_param.TYPE.FP16` | `drpai_param.TYPE.UINT8`|   

##### 2.4.2.5 Softmax()
```py
op.Softmax()
```

- **Supported only when `Config.mode` = `drpai_param.MODE.POST`**  

- Arguments  
    - None

- Restrictions  
    - 1 <= ( channel of input shape ) <= 16384  

- Supported In/Out parameters  

| Features | Input | Output |  
|:---|:---|:---|  
| Format | N/A| N/A|  
| Order | `drpai_param.ORDER.C`| Same as Input.|   
| Type | `drpai_param.TYPE.FP16` | `drpai_param.TYPE.FP16`</br> `drpai_param.TYPE.FP32`|   

#### 2.4.3 Constant Variables
Constant variables are defined as `drpai_param` module.  
##### 2.4.3.1 Format
| Class | Variable | Value | Details |  
|:---|:---|:---|:---|  
| `drpai_param.FORMAT` | `YUYV_422`| `0x0000`| Classified as YUV422.|  
| `drpai_param.FORMAT` | `YVYU_422`| `0x0001`| Classified as YUV422.|  
| `drpai_param.FORMAT` | `UYUV_422`| `0x0002`| Classified as YUV422.|  
| `drpai_param.FORMAT` | `VUYY_422`| `0x0003`| Classified as YUV422.|  
| `drpai_param.FORMAT` | `YUYV_420`| `0x1000`| Classified as YUV420.|  
| `drpai_param.FORMAT` | `UYVY_420`| `0x1001`|Classified as YUV420.|  
| `drpai_param.FORMAT` | `YV12_420`| `0x1002`|Classified as YUV420.|  
| `drpai_param.FORMAT` | `IYUV_420`| `0x1003`|Classified as YUV420.|  
| `drpai_param.FORMAT` | `NV12_420`| `0x1004`|Classified as YUV420.|  
| `drpai_param.FORMAT` | `NV21_420`| `0x1005`|Classified as YUV420.|  
| `drpai_param.FORMAT` | `IMC1_420`| `0x1006`|Classified as YUV420.|  
| `drpai_param.FORMAT` | `IMC2_420`| `0x1007`|Classified as YUV420.|  
| `drpai_param.FORMAT` | `IMC3_420`| `0x1008`|Classified as YUV420.|  
| `drpai_param.FORMAT` | `IMC4_420`| `0x1009`|Classified as YUV420.|  
| `drpai_param.FORMAT` | `RGB`| `0x2000`|-|  
| `drpai_param.FORMAT` | `BGR`| `0x2001`|-|  
| `drpai_param.FORMAT` | `GRAY`| `0x2010`|-|  
| `drpai_param.FORMAT` | `UNKNOWN`| `0xFFFF`|-|  

##### 2.4.3.2 Order
| Class | Variable | Value |  
|:---|:---|:---|  
| `drpai_param.ORDER` | `HWC`| `0x0000`|  
| `drpai_param.ORDER` | `CHW`| `0x0001`|  
| `drpai_param.ORDER` | `UNKNOWN`| `0xFFFF`|  
##### 2.4.3.3 Type
| Class | Variable | Value |   
|:---|:---|:---|  
| `drpai_param.TYPE` | `UINT8`| `0x0000`|  
| `drpai_param.TYPE` | `FP16`| `0x0001`|   
| `drpai_param.TYPE` | `FP32`| `0x0002`|  
| `drpai_param.TYPE` | `UNKNOWN`| `0xFFFF`|  

##### 2.4.3.4 Mode
| Class | Variable | Value | Details |   
|:---|:---|:---|:---|  
| `drpai_param.MODE` | `PRE`| `0x0000`| Used as default value.|  
| `drpai_param.MODE` | `POST`| `0x0001`| |  

### 2.5 Integration
To use DRP-AI Pre-processing Runtime Compile module, place the python script in the same directory with `drpai_preprocess` directory and import the module at the top of the script as shown below.
```py
from drpai_preprocess import * 
# Import other modules after the DRP-AI Preprocessing Runtime Compile module
# e.g.,
import os
```
Note: importing the DRP-AI Pre-processing Runtime Compile module after the other imports may cause the Segmentation Fault error.  

### 2.6 Sample Code
#### 2.6.1 Pre-processing
Following is a sample code for pre-processing, which generate DRP-AI Pre-processing Runtime Object for RZ/V2L into `preprocess` directory.
```py
from drpai_preprocess import * 

config = preruntime.Config()
config.shape_in     = [1, 480, 640, 2] #HWC
config.format_in    = drpai_param.FORMAT.YUYV_422
config.order_in     = drpai_param.ORDER.HWC
config.type_in      = drpai_param.TYPE.UINT8
config.shape_out    = [1, 3, 224, 224] #CHW
config.format_out   = drpai_param.FORMAT.RGB
config.order_out    = drpai_param.ORDER.CHW
config.type_out     = drpai_param.TYPE.FP32
config.ops = [
    op.Crop(0, 0, 480, 480), # crop top left 480x480 area.
    op.Resize(224, 224, op.Resize.BILINEAR),
    op.Normalize([-123.675, -116.28, -103.53], [0.01712475, 0.017507, 0.01742919])
    # Normalize with mean = [0.485, 0.456, 0.406 ] and stdev = [ 0.229, 0.224, 0.225 ]
]
preruntime.PreRuntime(config, "preprocess", "V2L")
```

#### 2.6.2 Post-processing
Following is a sample code for post-processing, which generate DRP-AI Pre-processing Runtime Object for RZ/V2L into `postprocess` directory.
```py
from drpai_preprocess import * 

config = preruntime.Config()
config.shape_in     = [1, 480, 640, 3] #HWC
config.order_in     = drpai_param.ORDER.HWC
config.type_in      = drpai_param.TYPE.FP32
config.shape_out    = [1, 480, 640, 1] #HWC
config.order_out    = drpai_param.ORDER.HWC
config.type_out     = drpai_param.TYPE.UINT8

config.mode         = drpai_param.MODE.POST 

config.ops = [
    op.Argminmax(0, 1), # argmax the channel (C) axis.
]
preruntime.PreRuntime(config, "postprocess", "V2L")
```


## 3. Run module
### 3.1 Overview
DRP-AI Pre-processing Runtime Object files generated by Compile module can be run on RZ/V Evaluation Board with the Run module.  
It allocates the Object files on DDR memory and assign it to DRP-AI.  
Users also can change some of the parameters specified when compiled the processing.  
Run module can be used by calling C++ API explained in this section.  

### 3.2 File configuration
| File | Details |  
|:---|:---|  
|`PreRuntime.cpp` | Pre-processing Runtime source code for RZ/V2L, RZ/V2M and RZ/V2MA. |
|`PreRuntimeV2H.cpp` | Pre-processing Runtime source code for RZ/V2H and RZ/V2N. |
|`PreRuntime.h` | Pre-processing Runtime header file. |

### 3.3 API

| Function | Description |  
|:---|:---|  
|[Load()](#331-load) | Loads Pre-processing Runtime Object files. |  
|[Pre()](#332-pre) | Runs pre-processing on DRP-AI. |  

#### 3.3.1 Load
| Items | Details |  
|:---|:---|  
| Overview | Loads Pre-processing Runtime Object files.  |  
| Definition | `uint8_t PreRuntime::Load(const std::string pre_dir, uint32_t start_addr)` |  
| Description | Initialize Pre-processing Runtime.  <br> Load Pre-processing Runtime Object files stored in `pre_dir` and deploy them to DRP-AI memory area. |  
| Arguments | 1. `const std::string pre_dir` = Directory name that contains Pre-processing Runtime Object files.</br>2.  (Optional)  `uint32_t start_addr` or `uint64_t start_addr` = Start address where Object files are dynamically allocated. </br>If not specified, start address of DRP-AI memory area will be used instead. </br>3. (Optional) `uint8_t mode` = Running mode where `MODE_PRE`(Default) or `MODE_POST`.  See [Pre/Post Mode](#354-prepost-mode). |  
| Return | 0  = if function succeeded <br> >0 = otherwise|  

#### 3.3.2 Pre
| Items | Details |  
|:---|:---|  
|Overview | Run pre-processing on DRP-AI with specified parameters. |   
| Definition | `uint8_t PreRuntime::Pre(s_preproc_param_t* param, void** out_ptr, uint32_t* out_size)` |  
| Description | Run pre-processing on DRP-AI.  Users can specify the pre-processing parameters in `param`.  The DRP-AI output will be stored in `out_ptr` and its size will be stored in `out_size`. |  
| Arguments | 1. `s_preproc_param_t* param` = Pre-processing parameters to be changed.  </br>Refer to [s_preproc_param_t](#341-s_preproc_param_t) for more details.<br> 2. `void** out_ptr` = Array pointer for DRP-AI output data.  Buffer will last until next call of this function. <br>  3. `uint32_t* out_size` = DRP-AI output buffer size. |  
| Return | 0  = if function succeeded <br> >0 = otherwise|  

### 3.4 Structure
#### 3.4.1 s_preproc_param_t
DRP-AI pre-processing parameter container.  
When user compiled the pre-processing using Compile module, these parameters are already defined.  
Members are shown below.  

| Type | Member variable | Details |Range |Invalid value</br>See [Notes.1](#notes) |  
|:---|:---|:---|---:|---:|  
|uint16_t | pre_in_shape_w | Input image width of pre-processing. |0~ |0xFFFF |  
|uint16_t | pre_in_shape_h | Input image height of pre-processing. |0~  |0xFFFF |  
|uint32_t | pre_in_addr| Start address of continuous memory area which stores the input image data. </br>See [Notes.2](#notes) |0~0xFFFFFFFE |0xFFFFFFFF |  
|uint16_t | pre_in_format | Input image format. |See [Format](#351-format) and [Format parameter change restriction](#36-format-parameter-change-restriction) |0xFFFF |  
|uint16_t | pre_out_format | Output image format. |[`FORMAT_GRAY`, `FORMAT_RGB`, `FORMAT_BGR`](#351-format)</br>See [Format parameter change restriction](#36-format-parameter-change-restriction).|0xFFFF |  
|uint8_t | resize_alg | Resize algorithm. |See [Resize Algorithm](#352-resize-algorithm)  |0xFF |  
|uint16_t | resize_w | Output image width of resize operator. |3~4096</br>See [Notes.3](#notes)  |0xFFFF |  
|uint16_t | resize_h | Output image height of resize operator. |3~4096</br>See [Notes.3](#notes)  |0xFFFF |  
|float[3] | cof_add | Addition coefficients for normalize operator. |[-(FLT_MAX-1)<br>~FLT_MAX] |[-FLT_MAX] |  
|float[3] | cof_mul | Multiplication coefficients for normalize operator. |-(FLT_MAX-1)<br>~FLT_MAX |[-FLT_MAX] |  
|uint16_t | crop_tl_x | X coordinates of top left corner of the crop box. |0~ |0xFFFF |  
|uint16_t | crop_tl_y | Y coordinates of top left corner of the crop box. |0~ |0xFFFF |  
|uint16_t | crop_w | Width of the crop box. |0~ </br>See [Notes.3](#notes) |0xFFFF |  
|uint16_t| crop_h | Height of the crop box. |0~ </br>See [Notes.3](#notes) |0xFFFF |  
|uint8_t | argmm_mode | Argminmax arguments mode. |See [Argminmax Mode](#353-argminmax-mode)  |0xFF |  
|bool | input_copy_enabled | Only available when using `PreRuntimeV2H.cpp`.</br>See [3.7.2.2 Input Data using PreRuntimeV2H.cpp](#3722-using-preruntimev2hcpp)  | true (Default)</br>false |N/A |  
##### Notes:  
1. If users specified the "Invalid value", the parameter uses the default value from Object files.  
2. `pre_in_addr` must be specified when `s_preproc_param_t` is defined. For other members, define the value if changes are necessary.  
3. For `resize_w`, `resize_h`, `crop_w` and `crop_h`, the new value **must be smaller than or equal to** the value specified when compiling the pre-processing.

### 3.5 Macro
Major Macro definition are as follows.
#### 3.5.1 Format
Macros to define the format.   

| Macro | Value |  
|:---|:---|  
|`FORMAT_YUYV_422` | `0x0000` |  
|`FORMAT_YVYU_422` | `0x0001` |  
|`FORMAT_UYUV_422` | `0x0002` |  
|`FORMAT_VUYY_422` | `0x0003` |  
|`FORMAT_YUYV_420` | `0x1000` |  
|`FORMAT_UYVY_420` | `0x1001` |  
|`FORMAT_YV12_420` | `0x1002` |  
|`FORMAT_IYUV_420` | `0x1003` |  
|`FORMAT_NV12_420` | `0x1004` |  
|`FORMAT_NV21_420` | `0x1005` |  
|`FORMAT_IMC1_420` | `0x1006` |  
|`FORMAT_IMC2_420` | `0x1007` |  
|`FORMAT_IMC3_420` | `0x1008` |  
|`FORMAT_IMC4_420` | `0x1009` |  
|`FORMAT_GRAY` | `0xFFFC` |  
|`FORMAT_BGR` | `0xFFFD` |  
|`FORMAT_RGB` | `0xFFFE` |  
|`FORMAT_UNKNOWN` | `0xFFFF` |  

#### 3.5.2 Resize Algorithm
Macros to define the algorithm for resize operation.  

| Macro | Value |  
|:---|:---|  
|`ALG_NEAREST` | `0` |  
|`ALG_BILINEAR` | `1` |  

#### 3.5.3 Argminmax Mode
Macros to define the mode for argminmax operation.  

| Macro | Value |  
|:---|:---|  
|`ARGMAX` | `0` |  
|`ARGMIN` | `1` |  

#### 3.5.4 Pre/Post Mode
Macros to define the runtime mode for Run Module.  

| Macro | Value |  
|:---|:---|  
|`MODE_PRE` | `0` |  
|`MODE_POST` | `1` |  


### 3.6 Format Parameter Change Restriction
When users change the input/output format of pre-processing using Run module, only following cases are allowed.  

| Parameter | Original Value | New Value | Conditions |  
|:---|:---|:---|:---|  
|`pre_in_format` | `FORMAT_*_420` | `FORMAT_*_420`, `FORMAT_*_422`| - |   
|`pre_in_format` | `FORMAT_*_422` | `FORMAT_*_420`, `FORMAT_*_422`| If output format specified in Compile module is RGB or BGR. |
|`pre_in_format` | `FORMAT_*_422` | `FORMAT_*_422`| If output format specified in Compile module is GRAY. |   
|`pre_in_format` | `FORMAT_RGB`</br>`FORMAT_BGR` | `FORMAT_RGB`</br>`FORMAT_BGR`|-|   
|`pre_out_format` | `FORMAT_RGB`</br>`FORMAT_BGR` | `FORMAT_RGB`</br>`FORMAT_BGR`|-|   


### 3.7 Integration
#### 3.7.1 Include Command  
1. Place the files listed in [File Configuration](#32-file-configuration) in the project directory.  
2. Include the `PreRuntime.h` file in the application source code.  
```cpp
#include "PreRuntime.h"
```
3. Include the Pre-processing source code (`PreRuntime.cpp` or `PreRuntimeV2H.cpp`) in the build command.  
For example, when using `PreRutime.cpp` as in cmake of [Application Example](../apps), add the filename to `CMakeLists.txt` as follows.
```diff
- set(SRC tutorial_app.cpp MeraDrpRuntimeWrapper.cpp)
+ set(SRC tutorial_app.cpp MeraDrpRuntimeWrapper.cpp PreRuntime.cpp)
set(EXE_NAME tutorial_app)

add_executable(${EXE_NAME} ${SRC})
target_link_libraries(${EXE_NAME} ${TVM_RUNTIME_LIB})
```
 

#### 3.7.2 Input Data  
To execute DRP-AI, all data, including the input data, must be stored in physically contiguous memory area.  
Input data stored memory address can be specified in [Run module API Pre()](#332-pre) with argument `s_preproc_param_t param.pre_in_addr` (See [s_preproc_param_t](#341-s_preproc_param_t)).  
```cpp  
uint8_t PreRuntime::Pre(s_preproc_param_t* param, void** out_ptr, uint32_t* out_size)
```

Implementation of input data preparation differs in `PreRuntime.cpp` and `PreRuntimeV2H.cpp`.  

##### 3.7.2.1 Using PreRuntime.cpp  
The input data must be stored in the data buffer that is assigned to physical memory area.  
[Application Example > tutorial_app_v2ml.cpp ](../apps/tutorial_app_v2ml.cpp) demonstrates how to allocate the buffer in physical memory area for Pre-processing Runtime.

##### 3.7.2.2 Using PreRuntimeV2H.cpp  
There are two methods to prepare input data buffer for `PreRuntimeV2H.cpp`.  
1. Virtual memory address buffer  
    Users can specify the pointer to input data buffer to `s_preproc_param_t param.pre_in_addr`.  
    By default, Pre-processing Runtime copies the input data stored in the specified pointer to DRP-AI memory area.  
    Please note that the processing time of `Pre()` includes the input data copy time using this method.  

    To see the example, please refer to [Application Example > tutorial_app.cpp ](../apps/tutorial_app.cpp).  

2. Physical memory address buffer  
    Instead of copying the data to DRP-AI memory area, users can prepare physically contiguous data buffer and specify its start address to `s_preproc_param_t param.pre_in_addr`.    

    To use the physical memory address buffer, `s_preproc_param_t param.input_copy_enabled` option must be set to `false`.  
    (By default, `input_copy_enabled = true; `).

    Here is a brief explanation to prepare physically contiguous data buffer.  
    If you would like to see the sample application, please refer to [R01_object_detection](https://github.com/renesas-rz/rzv_ai_sdk/blob/main/R01_object_detection).  
    > Note: R01_object_detection may not use the latest version of DRP-AI TVM[^1] and Pre-processing Runtime.  

    1. Copy [`dmabuf.cpp`](https://github.com/renesas-rz/rzv_ai_sdk/blob/main/R01_object_detection/src/dmabuf.cpp) and [`dmabuf.h`](https://github.com/renesas-rz/rzv_ai_sdk/blob/main/R01_object_detection/src/dmabuf.h) to your source code directory.  

    2. Modify `CMakeLists.txt` for dma buffer.
        ```diff
        - set(SRC main.cpp MeraDrpRuntimeWrapper.cpp PreRuntimeV2H.cpp)
        + set(SRC main.cpp MeraDrpRuntimeWrapper.cpp PreRuntimeV2H.cpp dmabuf.cpp)

        # omitted

        add_executable(${EXE_NAME} ${SRC})

        # omitted

        + target_link_libraries(${EXE_NAME} mmngr mmngrbuf)
        ```

    3. Include the "`dmabuf.h`" file for dma buffer.
        ```cpp
        /*dmabuf for Pre-processing Runtime input data*/
        #include "dmabuf.h"
        ```
    4. Create dma buffer as an input data buffer.
        ```cpp
        /*Define buffer for DRP-AI Pre-processing*/
        static dma_buffer *drpai_buf;
        drpai_buf = (dma_buffer*)malloc(sizeof(dma_buffer));
        int ret = buffer_alloc_dmabuf(drpai_buf, CAM_IMAGE_WIDTH*CAM_IMAGE_WIDTH*CAM_IMAGE_CHANNEL_BGR);
        if (-1 == ret)
        {
            free(drpai_buf);
            return -1;
        }
        ```
    5. Store input data into `(uint8_t*) drpai_buf->mem`

    6. Flush the buffer.
        ```cpp
        /* After storing the data to drpai_buf->mem, flush the buffer. */
        int ret_flush = buffer_flush_dmabuf(drpai_buf->idx, drpai_buf->size);
        if (0 != ret_flush )
        {
            buffer_free_dmabuf(drpai_buf);
            free(drpai_buf);
            return -1;
        }
        ```

    5. Set the physical address of `drpai_buf` and disable the `input_copy_enabled` option.
        ```cpp
        /* Define s_preproc_param_t for Pre-processing Runtime.*/
        s_preproc_param_t in_param;
        in_param.pre_in_addr = (uint64_t)drpai_buf->phy_addr;
        in_param.input_copy_enabled = false;
        ```

    6. Run Pre-processing runtime with `in_param` defined earlier.
        ```cpp
        /*Run pre-processing*/
        void *output_ptr;
        uint32_t out_size;
        uint8_t ret_prepre =  preruntime.Pre(&in_param, &output_ptr, &out_size);
        if (ret_prepre != 0)
        {
            buffer_free_dmabuf(drpai_buf);
            free(drpai_buf);
            return -1;
        }
        ```

#### 3.7.3 Multiple Processing  
Running multiple Pre-processing Runtime means that multiple directories of Pre-processing Runtime Object files are used.  
Followings are examples of using multiple Pre-processing Runtime.
- Using both pre-processing and post-processing.  
- Using different pre-processing for two AI models.  

When running multiple Pre-processing Runtime, please follow the notes below.  
1. Define `PreRuntime` class for each processing.  
    `PreRuntime` class keeps the parameter information of Pre-processing Runtime Object files loaded with `Load()` API.  
    When using multiple Pre-processing Runtime Object files, it is recommended to use define `PreRuntime` class for each Pre-processing Runtime Object files in order to avoid overwriting their parameter information.  

2. Do not allocate overlapped memory area in DRP-AI memory area.  
    Since DRP-AI uses the data deployed in physically contiguous memory area, each Pre-processing Runtime Object files must be deployed to memory area that is mutually exclusive.  
    For more details on memory management, please refer to [1.4 About Memory Management](#14-about-memory-management)  

    To avoid overlapping the memory area, it is important to know the necessary size of DRP-AI memory area to be used.  
    - For Pre-processing Runtime, the size can be checked in the the address map txt file (`*addrmap_intm.txt`) with following formulae.  
        - Object files for `PreRuntime.cpp`  
        ```
        (Necessary size of DRP-AI memory area) = ("desc_drp" address) + ("desc_drp" size) - ("data_in" address)
        ```
        - Object files for `PreRuntimeV2H.cpp`  
        ```
        (Necessary size of DRP-AI memory area) = ("drp_desc" address) + ("drp_desc" size) - ("data_in" address)
        ```
    
    - For DRP-AI TVM[^1], the size can be checked in the compile log.  
    Please see [How to read the Compile log](../how-to/tips/how-to-read-log.md#how-to-read-the-compile-log).  


### 3.8 Sample Code
#### 3.8.1 Pre-processing  
Please refer to [Application Example](../apps).

#### 3.8.2 Post-processing  
Following code shows how to call the Object files compiled in [2.6.3 Sample code for Post-processing](#262-post-processing) on RZ/V2L.  
Please refer to [Application Example](../apps) for `get_drpai_start_addr()`.
```cpp
#include "PreRuntime.cpp"

// omitted

uint32_t drpaimem_addr_start = get_drpai_start_addr();
std::string post_dir = "post_argminmax";

/*IMPORTANT: Make sure to specify "MODE_POST" in Load() to run post-processing.*/
uint8_t ret = preruntime.Load(post_dir, drpaimem_addr_start, MODE_POST);
if (ret != 0)
{
    std::cerr << "[ERROR] Failed to run Pre-processing Runtime Load()." << std::endl;
    return -1;
}

/*Note: Prepare input data on memory with address of "udmabuf_addr_start"*/

/*Specify the input data stored address and change parameter.*/
s_preproc_param_t in_param;
in_param.pre_in_addr    = (uint64_t)udmabuf_addr_start;
in_param.argmm_mode     = ARGMIN; //Change Argmm_mode from ARGMAX to ARGMIN.

/*Output variables for Pre-processing Runtime */
void *output_ptr;
uint32_t out_size = 0;

/*Run post-processing*/
ret = preruntime.Pre(&in_param, &output_ptr, &out_size);
if (ret != 0)
{
    std::cerr << "[ERROR] Failed to run Pre-processing Runtime Pre()." << std::endl;
    return -1;
}

/*Note: Read the data from "output_ptr"*/

```

[^1]: DRP-AI TVM is powered by EdgeCortix MERAâ„¢ Compiler Framework.
